name: Android CI

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'website/**'
      - 'docs/**'
      - 'LICENSE'
      - 'SECURITY.md'
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'website/**'
      - 'docs/**'
      - 'LICENSE'
      - 'SECURITY.md'

permissions:
  contents: read
  checks: write

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 60

    steps:
    - name: Checkout
      uses: actions/checkout@v6

    - name: Set up JDK 24
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '24'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5
      with:
        gradle-version: wrapper

    - name: Write Google Services JSON (Debug)
      env:
        FIREBASE_GOOGLE_SERVICES_JSON_DEBUG: ${{ secrets.FIREBASE_GOOGLE_SERVICES_JSON_DEBUG }}
      run: |
        mkdir -p androidApp/src/debug
        if [ -n "$FIREBASE_GOOGLE_SERVICES_JSON_DEBUG" ]; then
          echo "Decoding FIREBASE_GOOGLE_SERVICES_JSON_DEBUG..."
          echo "$FIREBASE_GOOGLE_SERVICES_JSON_DEBUG" | base64 --decode > androidApp/src/debug/google-services.json
        else
          echo "Secret FIREBASE_GOOGLE_SERVICES_JSON_DEBUG not found. Creating dummy google-services.json for build..."
          # Create a minimal dummy json to pass build configuration if possible
          echo '{
            "project_info": {
              "project_number": "000000000000",
              "project_id": "dummy-project",
              "storage_bucket": "dummy-project.appspot.com"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:000000000000:android:0000000000000000",
                  "android_client_info": {
                    "package_name": "app.lusk.underseerr"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "dummy_key"
                  }
                ],
                "services": {
                  "analytics_service": {
                    "status": 1
                  },
                  "appinvite_service": {
                    "status": 1,
                    "other_platform_oauth_client": []
                  },
                  "ads_service": {
                    "status": 2
                  }
                }
              }
            ],
            "configuration_version": "1"
          }' > androidApp/src/debug/google-services.json
        fi

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Run Unit Tests & Coverage
      run: ./gradlew jacocoTestReport

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v6
      with:
        name: coverage-report
        path: androidApp/build/reports/jacoco/jacocoTestReport/html/

    - name: Run Lint
      run: ./gradlew lintDebug

    - name: Assemble Debug APK
      run: ./gradlew assembleDebug

    - name: Upload Debug APK
      uses: actions/upload-artifact@v6
      with:
        name: minimal-android-debug
        path: androidApp/build/outputs/apk/debug/androidApp-debug.apk
